#!/bin/bash

set -eu

here="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

function genWithoutContextParameter() {
    how_many=$1

    echo ""

    echo "    @inlinable"
    echo -n "    public func transaction<C0: RESPCommand"
    for ((n = 1; n<$how_many; n +=1)); do
        echo -n ", C$(($n)): RESPCommand"
    done

    echo -n ">(_ c0: C0"
    for ((n = 1; n<$how_many; n +=1)); do
        echo -n ", _ c$(($n)): C$(($n))"
    done
    echo -n ") async throws -> (C0.Response"
    for ((n = 1; n<$how_many; n +=1)); do
        echo -n ", C$(($n)).Response"
    done
    echo ") {"
    echo -n "        guard let responses = try await self.pipeline(MULTI(), "
    for ((n = 0; n<$how_many; n +=1)); do
        echo -n "TransactionCommand(c$(($n))), "
    done
    echo "EXEC()).$(($how_many+1)) else { throw ValkeyClientError(.transactionAborted) }"

    echo -n "        return try (responses[0].converting()"
    for ((n = 1; n<$how_many; n +=1)); do
        echo -n ", responses[$(($n))].converting()"
    done
    echo ")"
    echo "    }"
}

{
cat <<"EOF"
/// NOTE: THIS FILE IS AUTO-GENERATED BY dev/generate-transaction-commands.sh
EOF
echo

echo "import NIOCore"
echo ""
echo "extension ValkeyConnection {
    /// Generic command used to disable conversion to a command Response type 
    @usableFromInline
    struct TransactionCommand<Command: RESPCommand>: RESPCommand {
        @usableFromInline
        let command: Command
        @usableFromInline
        init(_ command: Command) {
            self.command = command
        }
        @usableFromInline
        func encode(into commandEncoder: inout RESPCommandEncoder) {
            self.command.encode(into: &commandEncoder)
        }
    }
"
# note:
# - widening the inverval below (eg. going from {1..15} to {1..25}) is Semver minor
# - narrowing the interval below is SemVer _MAJOR_!
for n in {1..10}; do
    genWithoutContextParameter "$n"
done
echo "}"
} > "$here/../Sources/Valkey/Connection/ValkeyConnection+transactions.swift"

swift format format -i "$here/../Sources/Valkey/Connection/ValkeyConnection+transactions.swift"